<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Editor - Free Online PDF Editing Tool</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- PDF.js for rendering PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Fabric.js for canvas-based WYSIWYG editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- pdf-lib for PDF manipulation and export -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- fontkit for custom fonts in pdf-lib -->
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <!-- QR code: generate + scan for vault transfer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Header/Toolbar -->
        <header class="toolbar">
            <div class="toolbar-section">
                <h1 class="logo">PDF Editor</h1>
            </div>
            <div class="toolbar-section tools">
                <button id="btn-open" class="tool-btn primary" title="Open PDF">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 20H5V4h9v5h5v11zm-7-16H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7l-5-5z"/></svg>
                    <span>Open PDF</span>
                </button>
                <input type="file" id="file-input" accept=".pdf" hidden>

                <div class="divider"></div>

                <button id="btn-select" class="tool-btn active" title="Select (V)" data-tool="select">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M13.64 21.97C13.14 22.21 12.54 22 12.31 21.5L10.13 16.76L7.62 18.78C7.45 18.92 7.24 19 7 19C6.45 19 6 18.55 6 18V3C6 2.45 6.45 2 7 2C7.24 2 7.47 2.09 7.64 2.23L7.65 2.22L19.14 11.86C19.57 12.22 19.62 12.85 19.27 13.27C19.1 13.5 18.84 13.61 18.56 13.61L14.39 13.57L16.58 18.31C16.82 18.81 16.61 19.41 16.11 19.65L13.64 21.97Z"/></svg>
                </button>

                <button id="btn-text" class="tool-btn" title="Add Text (T)" data-tool="text">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M5 4v3h5.5v12h3V7H19V4H5z"/></svg>
                </button>

                <button id="btn-whiteout" class="tool-btn" title="Whiteout (W)" data-tool="whiteout">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/><rect fill="currentColor" x="7" y="7" width="10" height="10"/></svg>
                </button>

                <button id="btn-draw" class="tool-btn" title="Freehand Draw (D)" data-tool="draw">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>
                </button>
                <button id="btn-eraser" class="tool-btn" title="Eraser" data-tool="eraser">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M16.24 3c-.27 0-.52.11-.71.29L3 15.82V21h5.18L20.71 8.47c.39-.39.39-1.02 0-1.41l-3.76-3.76A.996.996 0 0 0 16.24 3zM7.35 19H5v-2.35l9.9-9.9 2.35 2.35-9.9 9.9zM19 19v2H11v-2h8z"/></svg>
                </button>

                <button id="btn-signature" class="tool-btn" title="Signature (S)" data-tool="signature">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M7 22v-2h14v2H7zm0-4v-2h14v2H7zm-5-4c.7 0 1.4-.2 2-.6l1.5 1.5c-1 .7-2.2 1.1-3.5 1.1v-2zm1.5-1.5L2 11c.4-.6.6-1.3.6-2H4.6c0 1.3-.4 2.5-1.1 3.5zM2 7c0-.7.2-1.4.6-2l1.5 1.5C3.4 6.8 3 7.4 3 8H1.1c-.1-.3-.1-.7-.1-1zm5-5h2v2c-.7 0-1.4.2-2 .6L5.5 3.1c.6-.4 1.3-.7 2-.8V2h.5zM4.1 3.1L5.6 4.6C5.2 5.2 5 5.8 5 6.5H3c0-1.3.4-2.5 1.1-3.4zm5.4 6.4c-.6.4-1.2.6-1.9.6L7.6 8.6c.3-.2.6-.4.8-.7l1.1 1.6z"/></svg>
                </button>

                <div class="divider"></div>

                <button id="btn-highlight" class="tool-btn" title="Highlight" data-tool="highlight">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6 14l3 3 9-9-3-3-9 9zm-2 6h6v-2H4v2z"/></svg>
                </button>
                <button id="btn-underline" class="tool-btn" title="Underline" data-tool="underline">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6 3v7a6 6 0 0 0 12 0V3h-2v7a4 4 0 0 1-8 0V3H6zm-2 18v-2h16v2H4z"/></svg>
                </button>
                <button id="btn-strike" class="tool-btn" title="Strikethrough" data-tool="strike">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M10 19h4v-2h-4c-1.1 0-2-.9-2-2h10v-2H4v2h2c0 2.21 1.79 4 4 4zm2-14c1.66 0 3 1.34 3 3h2c0-2.76-2.24-5-5-5H7v2h5z"/></svg>
                </button>
                <button id="btn-rect" class="tool-btn" title="Rectangle" data-tool="rect">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M4 6h16v12H4V6zm2 2v8h12V8H6z"/></svg>
                </button>
                <button id="btn-ellipse" class="tool-btn" title="Ellipse" data-tool="ellipse">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
                </button>
                <button id="btn-arrow" class="tool-btn" title="Arrow" data-tool="arrow">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M4 12h12l-4-4 1.41-1.41L20.83 12l-7.42 7.41L12 18l4-4H4v-2z"/></svg>
                </button>
                <button id="btn-note" class="tool-btn" title="Note" data-tool="note">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21 6h-2v9H7l-4 4V6c0-1.1.9-2 2-2h16v2z"/></svg>
                </button>
                <button id="btn-stamp" class="tool-btn" title="Stamp" data-tool="stamp">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M17 4H7v5a5 5 0 0 0 10 0V4zm-2 5a3 3 0 0 1-6 0V6h6v3zM5 20h14v-2H5v2zm1-6h12v2H6v-2z"/></svg>
                </button>
                <button id="btn-image" class="tool-btn" title="Insert Image" data-tool="image">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3 3.5-4.5L19 18H5l3.5-4.5z"/></svg>
                </button>

                <button id="btn-textfield" class="tool-btn" title="Form Text Field" data-tool="textfield">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M4 7v2h16V7H4zm0 6h16v-2H4v2zm0 4h16v-2H4v2z"/></svg>
                </button>

                <button id="btn-checkbox" class="tool-btn" title="Form Checkbox" data-tool="checkbox">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM17.99 9l-1.41-1.42-6.59 6.59-2.58-2.57-1.42 1.41 4 3.99z"/></svg>
                </button>

                <button id="btn-radio" class="tool-btn" title="Form Radio" data-tool="radio">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm0-14a6 6 0 1 0 0 12 6 6 0 0 0 0-12zm0 9a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                </button>
                <button id="btn-dropdown" class="tool-btn" title="Form Dropdown" data-tool="dropdown">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M5 7h14v4H5V7zm0 6h14v4H5v-4zm10 1l-3 3-3-3h6z"/></svg>
                </button>
                <button id="btn-date" class="tool-btn" title="Form Date Field" data-tool="date">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M7 11h2v2H7v-2zm4 0h2v2h-2v-2zm4 0h2v2h-2v-2zM19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
                </button>
            </div>

            <div class="toolbar-section tool-options" id="tool-options">
                <!-- Dynamic tool options appear here -->
            </div>

            <div class="toolbar-section actions">
                <button id="btn-undo" class="tool-btn" title="Undo (Ctrl+Z)" disabled>
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                </button>
                <button id="btn-redo" class="tool-btn" title="Redo (Ctrl+Y)" disabled>
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                </button>
                <button id="btn-delete" class="tool-btn" title="Delete Selected (Del)" disabled>
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>

                <div class="divider"></div>

                <button id="btn-save" class="tool-btn primary" title="Download PDF" disabled>
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>
                    <span>Download</span>
                </button>
                <button id="btn-send" class="tool-btn primary" title="Send via email" disabled>
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    <span>Send</span>
                </button>
                <button id="btn-vault" class="tool-btn" title="Vault – protect templates &amp; signatures">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                    <span id="btn-vault-label">Vault</span>
                </button>
                <button id="btn-templates" class="tool-btn" title="Email templates">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    <span>Templates</span>
                </button>
                <button id="btn-bulk-fill" class="tool-btn" title="Bulk fill from CSV">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    <span>Bulk Fill</span>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="welcome-screen">
                <div class="welcome-content">
                    <svg class="welcome-icon" viewBox="0 0 24 24" width="80" height="80">
                        <path fill="currentColor" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                        <path fill="currentColor" d="M9 13h6v2H9zm0 3h6v2H9zm0-6h4v2H9z"/>
                    </svg>
                    <h2>Welcome to PDF Editor</h2>
                    <p>Open a PDF file to start editing</p>
                    <button id="btn-open-welcome" class="welcome-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 20H5V4h9v5h5v11zm-7-16H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7l-5-5z"/></svg>
                        Open PDF File
                    </button>
                    <p class="hint">or drag and drop a PDF file here</p>
                </div>
            </div>

            <!-- PDF Viewer Container -->
            <div id="pdf-container" class="pdf-container hidden">
                <!-- Page Navigation -->
                <div class="page-nav">
                    <button id="btn-prev-page" class="nav-btn" disabled>
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <span class="page-info">
                        Page <input type="number" id="page-input" min="1" value="1"> of <span id="total-pages">1</span>
                    </span>
                    <button id="btn-next-page" class="nav-btn" disabled>
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>

                    <div class="zoom-controls">
                        <button id="btn-zoom-out" class="nav-btn" title="Zoom Out">
                            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 13H5v-2h14v2z"/></svg>
                        </button>
                        <span id="zoom-level">100%</span>
                        <button id="btn-zoom-in" class="nav-btn" title="Zoom In">
                            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        </button>
                        <button id="btn-fit-width" class="nav-btn" title="Fit Width">
                            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M4 15h16v-2H4v2zm0 4h16v-2H4v2zm0-8h16V9H4v2zm0-6v2h16V5H4z"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Signing flow banner: shown when document has our metadata (multi-signer flow) -->
                <div id="signing-flow-banner" class="signing-flow-banner hidden" role="status" aria-live="polite">
                    <div class="signing-flow-banner-content">
                        <span class="signing-flow-banner-icon" aria-hidden="true">✓</span>
                        <span id="signing-flow-banner-text"></span>
                        <button type="button" id="signing-flow-set-expected" class="signing-flow-set-btn" title="Set expected signers (order)">Set expected signers</button>
                    </div>
                </div>

                <div class="pdf-workspace">
                    <!-- Pages Sidebar -->
                    <aside class="pages-sidebar" id="pages-sidebar" aria-label="Pages">
                        <div class="pages-sidebar-header">
                            <div class="pages-sidebar-title">Pages</div>
                            <div class="pages-sidebar-actions">
                                <label class="pages-btn" for="pages-append-input" title="Append pages from another PDF">
                                    Append
                                </label>
                                <input type="file" id="pages-append-input" accept=".pdf" hidden>
                            </div>
                        </div>
                        <div class="pages-sidebar-toolbar">
                            <button type="button" class="pages-btn" id="pages-delete-btn" disabled>Delete</button>
                            <button type="button" class="pages-btn" id="pages-extract-btn" disabled>Extract</button>
                            <button type="button" class="pages-btn" id="pages-split-btn">Split…</button>
                            <button type="button" class="pages-btn" id="pages-rotate-btn" title="Rotate selected (or current) page(s) 90°. Shown in main view and thumbnails.">Rotate</button>
                        </div>
                        <div class="pages-list" id="pages-list" role="list">
                            <!-- Thumbnails injected here -->
                        </div>
                        <div class="pages-sidebar-footer">
                            <small class="pages-hint">Drag to reorder. Select pages to delete/extract/rotate.</small>
                        </div>
                    </aside>

                    <!-- Scrollable PDF Area -->
                    <div class="pdf-scroll-area" id="pdf-scroll-area">
                        <div class="pdf-pages" id="pdf-pages">
                            <!-- PDF pages will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Signature Modal -->
        <div id="signature-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create Signature</h3>
                    <button class="modal-close" id="signature-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="sig-disclosure" id="sig-disclosure">
                        By signing electronically, you consent to use electronic records and signatures. Your name and signing date will be stored in the document. You may request a paper copy.
                    </p>
                    <div class="sig-checkboxes">
                        <label class="sig-checkbox-label">
                            <input type="checkbox" id="sig-intent" name="sig-intent">
                            I agree to sign this document.
                        </label>
                        <label class="sig-checkbox-label">
                            <input type="checkbox" id="sig-consent" name="sig-consent">
                            I consent to use electronic signatures and records.
                        </label>
                    </div>
                    <div class="sig-identity">
                        <div class="sig-field">
                            <label for="sig-name">Signer name <span class="required">*</span></label>
                            <input type="text" id="sig-name" placeholder="Full name" class="sig-input" required>
                        </div>
                        <div class="sig-field">
                            <label for="sig-email">Email <span class="optional">(optional)</span></label>
                            <input type="email" id="sig-email" placeholder="email@example.com" class="sig-input">
                        </div>
                    </div>
                    <p class="sig-privacy" id="sig-privacy">
                        Your details are stored only in the downloaded PDF. Nothing is uploaded to any server.
                    </p>
                    <div class="signature-tabs">
                        <button class="sig-tab active" data-tab="draw">Draw</button>
                        <button class="sig-tab" data-tab="type">Type</button>
                        <button class="sig-tab" data-tab="image">Image</button>
                    </div>
                    <div class="signature-area">
                        <div id="sig-draw-area" class="sig-tab-content active">
                            <canvas id="signature-canvas" width="400" height="150"></canvas>
                            <button id="sig-clear" class="sig-clear">Clear</button>
                        </div>
                        <div id="sig-type-area" class="sig-tab-content">
                            <input type="text" id="sig-text-input" placeholder="Type your signature..." class="sig-text-input">
                            <div class="sig-font-options">
                                <label><input type="radio" name="sig-font" value="cursive" checked> Cursive</label>
                                <label><input type="radio" name="sig-font" value="handwriting"> Handwriting</label>
                                <label><input type="radio" name="sig-font" value="formal"> Formal</label>
                            </div>
                            <div id="sig-preview" class="sig-preview"></div>
                        </div>
                        <div id="sig-image-area" class="sig-tab-content">
                            <label class="sig-upload-label btn btn-secondary" for="sig-image-input">Choose image</label>
                            <input type="file" id="sig-image-input" accept="image/*" hidden>
                            <div id="sig-image-preview-wrap" class="sig-image-preview-wrap hidden">
                                <img id="sig-image-preview" class="sig-image-preview" alt="Signature preview">
                                <button type="button" id="sig-image-clear" class="sig-clear">Clear</button>
                            </div>
                        </div>
                    </div>
                    <div id="sig-my-signatures" class="sig-my-signatures hidden">
                        <div class="sig-my-signatures-header">Use a saved signature</div>
                        <div id="sig-saved-list" class="sig-saved-list"></div>
                    </div>
                    <div id="sig-save-current" class="sig-save-current hidden">
                        <input type="text" id="sig-save-name" class="sig-input" placeholder="Name for this signature">
                        <button type="button" id="sig-save-btn" class="btn btn-secondary">Save to My Signatures</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="sig-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="sig-apply" class="btn btn-primary" disabled>Insert Signature</button>
                </div>
            </div>
        </div>

        <!-- Send via Email Modal -->
        <div id="send-modal" class="modal hidden">
            <div class="modal-content modal-content--wide">
                <div class="modal-header">
                    <h3>Send via email</h3>
                    <button class="modal-close" id="send-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="send-template-row">
                        <label for="send-template-select">Template</label>
                        <select id="send-template-select" class="send-select"></select>
                    </div>
                    <div class="send-field">
                        <label for="send-subject">Subject</label>
                        <input type="text" id="send-subject" class="send-input" placeholder="Email subject">
                    </div>
                    <div class="send-field">
                        <label for="send-body">Body</label>
                        <textarea id="send-body" class="send-textarea" rows="10" placeholder="Email body"></textarea>
                    </div>
                    <p id="send-to-hint" class="send-to-hint hidden"></p>
                    <div class="send-field">
                        <label for="send-cc">CC (optional)</label>
                        <input type="text" id="send-cc" class="send-input" placeholder="cc@example.com, another@example.com">
                    </div>
                    <div class="send-field">
                        <label for="send-bcc">BCC (optional)</label>
                        <input type="text" id="send-bcc" class="send-input" placeholder="bcc@example.com">
                    </div>
                    <p class="send-hint"><strong>Important:</strong> The PDF will be downloaded automatically. Your email app will open with this subject and body. <strong>You MUST manually attach the downloaded PDF file to the email before sending.</strong> Make sure to attach the file that was just downloaded—do not attach a different version.</p>
                    <p class="send-footer-note"><a href="#" id="send-manage-templates" class="send-link">Manage email templates</a></p>
                </div>
                <div class="modal-footer">
                    <button id="send-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="send-do" class="btn btn-primary">Download PDF &amp; open email</button>
                </div>
            </div>
        </div>

        <!-- Email Templates Modal -->
        <div id="templates-modal" class="modal hidden">
            <div class="modal-content modal-content--wide">
                <div class="modal-header">
                    <h3>Email templates</h3>
                    <button class="modal-close" id="templates-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="templates-vault-locked" class="vault-locked-banner hidden">
                        <span>Vault locked.</span> <a href="#" id="templates-unlock-link" class="send-link">Unlock</a> to manage templates.
                    </div>
                    <div class="templates-toolbar">
                        <button id="tpl-add" class="btn btn-primary">Add template</button>
                        <button id="tpl-export" class="btn btn-secondary">Export</button>
                        <label class="btn btn-secondary" for="tpl-import-input">Import</label>
                        <input type="file" id="tpl-import-input" accept=".json,application/json" hidden>
                        <label class="tpl-import-replace">
                            <input type="checkbox" id="tpl-import-replace-cb"> Replace existing
                        </label>
                    </div>
                    <ul id="templates-list" class="templates-list"></ul>
                    <p class="templates-placeholders">Placeholders: {{filename}}, {{date}}, {{signatureSummary}}, {{signerNames}}, {{pageCount}}, {{documentHash}}, {{attachmentNote}}, {{editLink}}</p>
                </div>
            </div>
        </div>

        <!-- Template Edit Modal (add/edit) -->
        <div id="template-edit-modal" class="modal hidden">
            <div class="modal-content modal-content--wide">
                <div class="modal-header">
                    <h3 id="template-edit-title">Add template</h3>
                    <button class="modal-close" id="template-edit-close">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="tpl-edit-id" value="">
                    <div class="send-field">
                        <label for="tpl-edit-name">Name</label>
                        <input type="text" id="tpl-edit-name" class="send-input" placeholder="e.g. Contract submission">
                    </div>
                    <div class="send-field">
                        <label for="tpl-edit-subject">Subject</label>
                        <input type="text" id="tpl-edit-subject" class="send-input" placeholder="{{filename}}">
                    </div>
                    <div class="send-field">
                        <label for="tpl-edit-body">Body</label>
                        <textarea id="tpl-edit-body" class="send-textarea" rows="10" placeholder="Use placeholders: {{filename}}, {{date}}, ..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="tpl-edit-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="tpl-edit-save" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Expected signers modal (multi-signer flow) -->
        <div id="expected-signers-modal" class="modal hidden">
            <div class="modal-content modal-content--wide">
                <div class="modal-header">
                    <h3>Expected signers (order)</h3>
                    <button class="modal-close" id="expected-signers-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="bulk-fill-hint">Add or remove signers in the order they should sign. The number can default from signature placements on the document.</p>
                    <div class="expected-signers-toolbar">
                        <button type="button" id="expected-signers-add" class="btn btn-primary">Add signer</button>
                    </div>
                    <div id="expected-signers-list" class="expected-signers-list" role="list"></div>
                    <div class="send-field" style="margin-top: 16px;">
                        <label for="expected-signers-completion-to">When complete, send document to (To: email or comma-separated)</label>
                        <input type="text" id="expected-signers-completion-to" class="send-input" placeholder="you@example.com or all@x.com, signer2@x.com">
                        <small class="bulk-fill-hint">The last signer will have the email client open with these addresses in To. Use multiple emails to send to everyone.</small>
                    </div>
                    <div class="send-field">
                        <label for="expected-signers-completion-cc">CC when complete (optional)</label>
                        <input type="text" id="expected-signers-completion-cc" class="send-input" placeholder="cc@example.com, another@example.com">
                    </div>
                    <div class="send-field">
                        <label for="expected-signers-completion-bcc">BCC when complete (optional)</label>
                        <input type="text" id="expected-signers-completion-bcc" class="send-input" placeholder="bcc@example.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="expected-signers-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="expected-signers-save" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Vault Modal (create / unlock) -->
        <div id="vault-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="vault-modal-title">Vault</h3>
                    <button class="modal-close" id="vault-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="vault-create-panel" class="vault-panel hidden">
                        <p class="vault-hint">Protect templates and saved signatures with a password. Data is encrypted locally; nothing is uploaded.</p>
                        <div class="send-field">
                            <label for="vault-create-name">Vault name</label>
                            <input type="text" id="vault-create-name" class="send-input" placeholder="e.g. Work, Personal" autocomplete="off">
                        </div>
                        <div class="send-field">
                            <label for="vault-create-password">Password</label>
                            <input type="password" id="vault-create-password" class="send-input" placeholder="Choose a password" autocomplete="new-password">
                        </div>
                        <div class="send-field">
                            <label for="vault-create-confirm">Confirm password</label>
                            <input type="password" id="vault-create-confirm" class="send-input" placeholder="Confirm password" autocomplete="new-password">
                        </div>
                        <p id="vault-create-error" class="vault-error hidden"></p>
                        <button id="vault-create-btn" class="btn btn-primary">Create vault</button>
                    </div>
                    <div id="vault-unlock-panel" class="vault-panel hidden">
                        <p class="vault-hint" id="vault-unlock-hint">Enter the vault password.</p>
                        <div class="send-field" id="vault-unlock-select-wrap">
                            <label for="vault-unlock-select">Vault</label>
                            <select id="vault-unlock-select" class="send-input"></select>
                        </div>
                        <div class="send-field hidden" id="vault-unlock-single-wrap">
                            <label>Vault</label>
                            <p id="vault-unlock-single-name" class="vault-single-name"></p>
                        </div>
                        <div class="send-field">
                            <label for="vault-unlock-password">Password</label>
                            <input type="password" id="vault-unlock-password" class="send-input" placeholder="Vault password" autocomplete="current-password">
                        </div>
                        <p id="vault-unlock-error" class="vault-error hidden"></p>
                        <div class="vault-unlock-actions">
                            <button id="vault-unlock-btn" class="btn btn-primary">Unlock</button>
                            <button id="vault-delete-btn" class="btn btn-secondary">Delete vault</button>
                        </div>
                        <p class="vault-unlock-footer"><a href="#" id="vault-create-another-link" class="send-link">Create another vault</a></p>
                    </div>
                    <div id="vault-unlocked-panel" class="vault-panel hidden">
                        <p class="vault-unlocked-name">Vault: <strong id="vault-unlocked-name"></strong></p>
                        <div class="vault-unlocked-actions">
                            <button id="vault-lock-btn" class="btn btn-secondary">Lock vault</button>
                            <button id="vault-switch-btn" class="btn btn-secondary">Switch to another vault</button>
                            <button id="vault-rename-btn" class="btn btn-secondary">Rename vault</button>
                            <button id="vault-export-btn" class="btn btn-secondary">Export vault</button>
                            <span class="vault-transfer-label">Transfer:</span>
                            <button id="vault-transfer-qr-btn" class="btn btn-secondary">Show QR codes</button>
                            <button id="vault-transfer-copy-btn" class="btn btn-secondary">Copy to clipboard</button>
                            <button id="vault-delete-current-btn" class="btn btn-secondary">Delete this vault</button>
                        </div>
                        <div id="vault-transfer-send-panel" class="vault-transfer-panel hidden">
                            <p class="vault-hint">Point the other device’s camera at this screen. QR codes will cycle automatically until all parts are received.</p>
                            <div id="vault-transfer-qr-wrap" class="vault-qr-wrap"></div>
                            <p id="vault-transfer-progress" class="vault-transfer-progress"></p>
                            <button id="vault-transfer-send-cancel" class="btn btn-secondary">Done</button>
                        </div>
                        <div id="vault-rename-form" class="vault-rename-form hidden">
                            <div class="send-field">
                                <label for="vault-rename-password">Current password</label>
                                <input type="password" id="vault-rename-password" class="send-input" placeholder="Password" autocomplete="current-password">
                            </div>
                            <div class="send-field">
                                <label for="vault-rename-new">New name</label>
                                <input type="text" id="vault-rename-new" class="send-input" placeholder="Vault name" autocomplete="off">
                            </div>
                            <p id="vault-rename-error" class="vault-error hidden"></p>
                            <button id="vault-rename-save" class="btn btn-primary">Save name</button>
                        </div>
                    </div>
                    <div id="vault-import-section" class="vault-panel vault-import-section">
                        <p class="vault-hint vault-backup-hint">Plain backup (no password): saved to or loaded from local storage.</p>
                        <div class="vault-backup-actions">
                            <button id="vault-export-plain-section-btn" class="btn btn-secondary">Export to file</button>
                            <label for="vault-import-plain-input" class="btn btn-secondary">Import from file</label>
                        </div>
                        <input type="file" id="vault-import-plain-input" accept=".json,application/json" hidden>
                        <p class="vault-hint">Import an encrypted vault from another device. Same password works.</p>
                        <div class="vault-transfer-receive-actions">
                            <button id="vault-receive-btn" class="btn btn-secondary">Scan QR</button>
                            <button id="vault-receive-paste-btn" class="btn btn-secondary">Paste transfer data</button>
                            <span class="vault-import-or">or</span>
                            <label for="vault-import-input" class="btn btn-secondary">Choose vault file</label>
                        </div>
                        <div id="vault-paste-panel" class="vault-transfer-panel hidden">
                            <p class="vault-hint">Paste the transfer data (from Copy on the other device) below.</p>
                            <textarea id="vault-paste-input" class="vault-paste-input" placeholder="Paste here..." rows="4"></textarea>
                            <p id="vault-paste-error" class="vault-error hidden"></p>
                            <button id="vault-paste-import-btn" class="btn btn-primary">Import</button>
                            <button id="vault-paste-cancel" class="btn btn-secondary">Cancel</button>
                        </div>
                        <input type="file" id="vault-import-input" accept=".json,application/json" hidden>
                        <div id="vault-receive-panel" class="vault-transfer-panel hidden">
                            <p class="vault-hint">Point your camera at the other device’s screen. Keep scanning until all parts are received.</p>
                            <div class="vault-receive-video-wrap">
                                <video id="vault-receive-video" playsinline muted></video>
                                <canvas id="vault-receive-canvas" hidden></canvas>
                            </div>
                            <p id="vault-receive-progress" class="vault-transfer-progress"></p>
                            <button id="vault-receive-cancel" class="btn btn-secondary">Cancel</button>
                        </div>
                        <div id="vault-receive-done" class="vault-receive-done hidden">
                            <p class="vault-hint">Vault received. Enter the vault password to import.</p>
                            <div class="send-field">
                                <label for="vault-receive-password">Password for vault</label>
                                <input type="password" id="vault-receive-password" class="send-input" placeholder="Password" autocomplete="current-password">
                            </div>
                            <p id="vault-receive-error" class="vault-error hidden"></p>
                            <button id="vault-receive-import-btn" class="btn btn-primary">Import as new vault</button>
                        </div>
                        <div id="vault-import-form" class="vault-import-form hidden">
                            <div class="send-field">
                                <label for="vault-import-password">Password for vault file</label>
                                <input type="password" id="vault-import-password" class="send-input" placeholder="Password" autocomplete="current-password">
                            </div>
                            <p id="vault-import-error" class="vault-error hidden"></p>
                            <div class="vault-import-actions">
                                <button id="vault-import-new-btn" class="btn btn-primary">Import as new vault</button>
                                <button id="vault-import-replace-btn" class="btn btn-secondary hidden">Replace current vault</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Fill Modal -->
        <div id="bulk-fill-modal" class="modal hidden">
            <div class="modal-content modal-content--wide">
                <div class="modal-header">
                    <h3>Bulk Fill PDFs from CSV</h3>
                    <button class="modal-close" id="bulk-fill-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="bulk-fill-description">
                        Bulk fill the PDF you already have open using a CSV file. Each row will generate a separate filled PDF that downloads automatically.
                    </p>
                    <div id="bulk-fill-template-status" class="bulk-fill-hint"></div>
                    
                    <div class="send-field">
                        <label for="bulk-fill-template">PDF Template (optional override)</label>
                        <input type="file" id="bulk-fill-template" accept=".pdf" class="send-input">
                        <small class="bulk-fill-hint">Leave blank to use the currently open document. Upload a different PDF only if you want to override the template.</small>
                    </div>

                    <div class="send-field">
                        <label for="bulk-fill-csv">CSV File</label>
                        <input type="file" id="bulk-fill-csv" accept=".csv" class="send-input">
                        <small class="bulk-fill-hint">CSV file with column headers matching PDF field names</small>
                    </div>

                    <div class="send-field">
                        <label for="bulk-fill-filename">Filename Template</label>
                        <input type="text" id="bulk-fill-filename" class="send-input" placeholder="contract-{{tenant_name}}.pdf" value="document-{{row}}.pdf">
                        <small class="bulk-fill-hint">Use {{column_name}} to insert CSV column values. Default: document-{{row}}.pdf</small>
                    </div>

                    <div id="bulk-fill-mapping" class="bulk-fill-mapping hidden">
                        <h4>Field Mapping</h4>
                        <p class="bulk-fill-hint">Map CSV columns to PDF form fields. Leave unmapped to skip.</p>
                        <div id="bulk-fill-mapping-list"></div>
                    </div>

                    <div id="bulk-fill-email-section" class="bulk-fill-email-section hidden">
                        <h4>Send emails (optional)</h4>
                        <p class="bulk-fill-hint">Select one or more columns that contain recipient emails (e.g. one column per signer). You can add an email directly in a row if it’s missing. Send is only allowed when at least one email is set for that row.</p>
                        <div class="bulk-fill-email-row">
                            <div class="send-field">
                                <label for="bulk-fill-email-column">Email column(s)</label>
                                <select id="bulk-fill-email-column" class="send-input bulk-fill-select" multiple size="4">
                                </select>
                                <small class="bulk-fill-hint">Hold Ctrl/Cmd to select multiple columns (e.g. signer 1, signer 2).</small>
                            </div>
                            <div class="send-field">
                                <label for="bulk-fill-email-template">Email template</label>
                                <select id="bulk-fill-email-template" class="send-input bulk-fill-select"></select>
                            </div>
                        </div>
                        <div id="bulk-fill-rows" class="bulk-fill-rows hidden">
                            <h4>Rows</h4>
                            <p class="bulk-fill-hint">Download a filled PDF or send an email for each row.</p>
                            <div class="bulk-fill-rows-toolbar">
                                <button type="button" id="bulk-fill-send-all" class="btn btn-primary" disabled>Send all emails</button>
                                <span id="bulk-fill-send-all-status" class="bulk-fill-send-all-status hidden"></span>
                            </div>
                            <div id="bulk-fill-rows-list" class="bulk-fill-rows-list"></div>
                        </div>
                    </div>

                    <div id="bulk-fill-progress" class="bulk-fill-progress hidden">
                        <div class="bulk-fill-progress-bar">
                            <div id="bulk-fill-progress-fill" class="bulk-fill-progress-fill"></div>
                        </div>
                        <p id="bulk-fill-progress-text">Processing...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="bulk-fill-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="bulk-fill-process" class="btn btn-primary" disabled>Process & Download</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
            <p id="loading-text">Loading...</p>
        </div>
    </div>

    <script src="js/app.js" type="module"></script>
</body>
</html>
